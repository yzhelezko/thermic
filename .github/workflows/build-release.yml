name: Build and Release

on:
  push:
    tags: [ 'v*' ]

# Add permissions for GitHub Actions
permissions:
  contents: write  # Required for creating releases and uploading assets
  actions: read    # Required for downloading artifacts

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  build:
    strategy:
      matrix:
        platform:
          - os: windows-latest
            target: windows/amd64
            name: thermic-windows-amd64.exe
          - os: ubuntu-latest
            target: linux/amd64
            name: thermic-linux-amd64
          - os: macos-latest
            target: darwin/amd64
            name: thermic-darwin-amd64.zip
          - os: macos-latest
            target: darwin/arm64
            name: thermic-darwin-arm64.zip

    runs-on: ${{ matrix.platform.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (Ubuntu)
        if: matrix.platform.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install dependencies (macOS)
        if: matrix.platform.os == 'macos-latest'
        run: |
          # No additional dependencies needed for macOS

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install
          cd ..

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Verify Wails installation
        run: wails doctor

      - name: Get version info
        id: version
        shell: bash
        run: |
          # Get version from git tag or set default
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "git_commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Build application (Linux)
        if: matrix.platform.os == 'ubuntu-latest'
        run: |
          wails build -platform ${{ matrix.platform.target }} -clean -tags webkit2_41 \
            -ldflags "-X main.Version=${{ steps.version.outputs.version }} -X main.GitCommit=${{ steps.version.outputs.git_commit }} -X main.BuildDate=${{ steps.version.outputs.build_date }}"

      - name: Build application (Windows)
        if: matrix.platform.os == 'windows-latest'
        run: |
          wails build -platform ${{ matrix.platform.target }} -clean -ldflags "-X main.Version=${{ steps.version.outputs.version }} -X main.GitCommit=${{ steps.version.outputs.git_commit }} -X main.BuildDate=${{ steps.version.outputs.build_date }}"

      - name: Build application (macOS)
        if: matrix.platform.os == 'macos-latest'
        run: |
          wails build -platform ${{ matrix.platform.target }} -clean \
            -ldflags "-X main.Version=${{ steps.version.outputs.version }} -X main.GitCommit=${{ steps.version.outputs.git_commit }} -X main.BuildDate=${{ steps.version.outputs.build_date }}"

      - name: Debug build output
        shell: bash
        run: |
          echo "Build directory contents:"
          ls -la build/
          echo "Build bin directory contents:"
          ls -la build/bin/ || echo "No build/bin directory"

      - name: Prepare artifacts (Windows)
        if: matrix.platform.os == 'windows-latest'
        shell: bash
        run: |
          mkdir -p artifacts
          # Find the executable file (should be Thermic.exe with capital T)
          if [ -f "build/bin/Thermic.exe" ]; then
            cp build/bin/Thermic.exe artifacts/${{ matrix.platform.name }}
          else
            echo "Windows executable not found"
            ls -la build/bin/
            exit 1
          fi

      - name: Prepare artifacts (Linux)
        if: matrix.platform.os == 'ubuntu-latest'
        run: |
          mkdir -p artifacts
          # Find the executable file (should be Thermic with capital T)
          if [ -f "build/bin/Thermic" ]; then
            cp build/bin/Thermic artifacts/${{ matrix.platform.name }}
          else
            echo "Linux executable not found"
            ls -la build/bin/
            exit 1
          fi

      - name: Prepare artifacts (macOS)
        if: matrix.platform.os == 'macos-latest'
        run: |
          mkdir -p artifacts
          # On macOS, Wails creates a .app bundle - we want to preserve the complete bundle
          if [ -d "build/bin/Thermic.app" ]; then
            # Create a zip file containing the complete .app bundle
            # Remove .zip from matrix name to avoid double extension
            BASE_NAME="${{ matrix.platform.name }}"
            BASE_NAME="${BASE_NAME%.zip}"
            cd build/bin
            zip -r "../../artifacts/${BASE_NAME}.zip" Thermic.app
            cd ../..
          else
            echo "macOS app bundle not found"
            echo "Contents of build/bin/:"
            ls -la build/bin/
            exit 1
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform.name }}
          path: artifacts/${{ matrix.platform.name }}

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper tag comparison

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -la artifacts/

      - name: Debug artifact structure
        run: |
          echo "=== Detailed artifact structure ==="
          find artifacts/ -type f -exec ls -la {} \;
          echo "=== End artifact structure ==="

      - name: Generate dynamic release notes
        id: release_notes
        run: |
          # Configure git to prevent hanging
          git config --global core.pager cat
          export GIT_PAGER=cat
          
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+" | head -2 | tail -1)
          CURRENT_TAG="${{ github.ref_name }}"
          
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREVIOUS_TAG"
          
          # Generate categorized commit log since last tag
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to $CURRENT_TAG"
            
            # Get all commits with full body text
            ALL_COMMITS=$(git log --pretty=format:"%s|%b|%h|%an" $PREVIOUS_TAG..$CURRENT_TAG --no-merges)
            COMMIT_COUNT=$(git rev-list --count $PREVIOUS_TAG..$CURRENT_TAG --no-merges)
            
          else
            echo "No previous tag found, showing recent commits"
            ALL_COMMITS=$(git log --pretty=format:"%s|%b|%h|%an" --max-count=10 --no-merges)
            COMMIT_COUNT=$(git rev-list --count HEAD --max-count=10 --no-merges)
          fi
          
          # Extract and categorize bullet points from commits
          FEATURES=""
          FIXES=""
          IMPROVEMENTS=""
          OTHER=""
          
          # Process each commit
          while IFS='|' read -r subject body hash author; do
            # First, categorize the main commit message
            commit_category=""
            if [[ $subject =~ ^[Ff]eat.*|^[Aa]dd.*|^[Nn]ew.* ]]; then
              commit_category="FEATURES"
            elif [[ $subject =~ ^[Ff]ix.*|^[Bb]ug.*|^[Rr]epair.* ]]; then
              commit_category="FIXES"
            elif [[ $subject =~ ^[Ii]mprove.*|^[Ee]nhance.*|^[Oo]ptimize.*|^[Uu]pdate.*|^[Rr]efactor.* ]]; then
              commit_category="IMPROVEMENTS"
            else
              commit_category="OTHER"
            fi
            
                         # Extract bullet points from commit body (clean up whitespace and encoding)
             bullet_points=$(echo "$body" | grep -E "^\s*[-â€¢]\s+" | sed 's/^\s*[-â€¢]\s*//' | sed 's/[[:space:]]*$//' | tr -d '\r')
             
             if [ -n "$bullet_points" ]; then
               # Add bullet points with commit reference
               while IFS= read -r bullet; do
                 if [ -n "$bullet" ] && [ "$bullet" != "-" ]; then
                   # Clean the bullet point text
                   clean_bullet="- $(echo "$bullet" | sed 's/[[:space:]]*$//' | tr -d '\r')"
                   
                   # Categorize bullet points based on keywords
                   if [[ $clean_bullet =~ [Ff]eat|[Aa]dd|[Nn]ew|[Ii]mplement ]]; then
                     FEATURES="${FEATURES}${clean_bullet}\n"
                   elif [[ $clean_bullet =~ [Ff]ix|[Bb]ug|[Rr]epair|[Cc]orrect ]]; then
                     FIXES="${FIXES}${clean_bullet}\n"
                   elif [[ $clean_bullet =~ [Ii]mprove|[Ee]nhance|[Oo]ptimize|[Uu]pdate|[Rr]efactor ]]; then
                     IMPROVEMENTS="${IMPROVEMENTS}${clean_bullet}\n"
                   else
                     # Use the commit's category for uncategorized bullet points
                     case $commit_category in
                       "FEATURES") FEATURES="${FEATURES}${clean_bullet}\n" ;;
                       "FIXES") FIXES="${FIXES}${clean_bullet}\n" ;;
                       "IMPROVEMENTS") IMPROVEMENTS="${IMPROVEMENTS}${clean_bullet}\n" ;;
                       *) OTHER="${OTHER}${clean_bullet}\n" ;;
                     esac
                   fi
                 fi
               done <<< "$bullet_points"
             else
               # No bullet points, add the main subject
               case $commit_category in
                 "FEATURES") FEATURES="${FEATURES}- ${subject}\n" ;;
                 "FIXES") FIXES="${FIXES}- ${subject}\n" ;;
                 "IMPROVEMENTS") IMPROVEMENTS="${IMPROVEMENTS}- ${subject}\n" ;;
                 *) OTHER="${OTHER}- ${subject}\n" ;;
               esac
             fi
          done <<< "$ALL_COMMITS"
          
          # Get build info
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          GIT_COMMIT=$(git rev-parse --short HEAD)
          
          # Get contributors since last tag
          if [ -n "$PREVIOUS_TAG" ]; then
            CONTRIBUTORS=$(git log --pretty=format:"%an" $PREVIOUS_TAG..$CURRENT_TAG --no-merges | sort -u | sed 's/^/- /')
          else
            CONTRIBUTORS=$(git log --pretty=format:"%an" --max-count=10 --no-merges | sort -u | sed 's/^/- /')
          fi
          
          # Create release notes
          cat << EOF > release_notes.md
          ## Thermic $CURRENT_TAG
          
          Cross-platform terminal emulator with advanced SSH connection management and WSL support.
          
          ### ðŸŽ¯ What's New in This Release
          
          EOF
          
          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "**$COMMIT_COUNT commits** since ${PREVIOUS_TAG:-"initial development"}:" >> release_notes.md
            echo "" >> release_notes.md
            
            # Add categorized sections
            if [ -n "$FEATURES" ]; then
              echo "#### ðŸ†• New Features" >> release_notes.md
              echo -e "$FEATURES" >> release_notes.md
            fi
            
            if [ -n "$IMPROVEMENTS" ]; then
              echo "#### ðŸ”§ Improvements & Updates" >> release_notes.md
              echo -e "$IMPROVEMENTS" >> release_notes.md
            fi
            
            if [ -n "$FIXES" ]; then
              echo "#### ðŸ› Bug Fixes" >> release_notes.md
              echo -e "$FIXES" >> release_notes.md
            fi
            
            if [ -n "$OTHER" ]; then
              echo "#### ðŸ“ Other Changes" >> release_notes.md
              echo -e "$OTHER" >> release_notes.md
            fi
          else
            echo "Initial release with core terminal emulator functionality." >> release_notes.md
          fi
          
          cat << EOF >> release_notes.md
          
          ### ðŸ“¦ Downloads
          - **Windows**: thermic-windows-amd64.exe
          - **Linux**: thermic-linux-amd64  
          - **macOS Intel**: thermic-darwin-amd64.zip (contains Thermic.app)
          - **macOS Apple Silicon**: thermic-darwin-arm64.zip (contains Thermic.app)
          
          ### ðŸš€ Installation
          
          #### Windows
          1. Download thermic-windows-amd64.exe
          2. Run the executable
          
          #### Linux
          1. Download thermic-linux-amd64
          2. Make it executable: \`chmod +x thermic-linux-amd64\`
          3. Run the application: \`./thermic-linux-amd64\`
          
          #### macOS
          1. Download the appropriate zip file for your Mac (Intel or Apple Silicon)
          2. Extract the zip file to reveal Thermic.app
          3. Drag Thermic.app to your Applications folder
          4. Launch from Applications or Launchpad
          
          ### ðŸ”„ Auto-Update
          The application automatically checks for updates and notifies you through the status bar.
          EOF
          
          # Add contributors section if there are any
          if [ -n "$CONTRIBUTORS" ]; then
            echo "" >> release_notes.md
            echo "### ðŸ‘¥ Contributors" >> release_notes.md
            echo "Thanks to everyone who contributed to this release:" >> release_notes.md
            echo "" >> release_notes.md
            echo "$CONTRIBUTORS" >> release_notes.md
          fi
          
          cat << EOF >> release_notes.md
          
          ### ðŸ“‹ Build Information
          - **Build Date**: $BUILD_DATE
          - **Git Commit**: $GIT_COMMIT
          - **Platforms**: Windows (amd64), Linux (amd64), macOS (Intel + Apple Silicon)
          EOF
          
          # Debug output
          echo "=== Debug Information ==="
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREVIOUS_TAG"
          echo "Commit count: $COMMIT_COUNT"
          echo "Features found: $([ -n "$FEATURES" ] && echo "YES" || echo "NO")"
          echo "Fixes found: $([ -n "$FIXES" ] && echo "YES" || echo "NO")"
          echo "Improvements found: $([ -n "$IMPROVEMENTS" ] && echo "YES" || echo "NO")"
          echo "Other changes found: $([ -n "$OTHER" ] && echo "YES" || echo "NO")"
          echo "Contributors found: $([ -n "$CONTRIBUTORS" ] && echo "YES" || echo "NO")"
          echo "=========================="
          
          # Output for GitHub Actions
          echo "Generated release notes:"
          cat release_notes.md
          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create Release with Assets
        uses: softprops/action-gh-release@v1
        with:
          name: Thermic ${{ github.ref_name }}
          body_path: ${{ steps.release_notes.outputs.release_notes_file }}
          files: |
            artifacts/thermic-windows-amd64.exe/thermic-windows-amd64.exe
            artifacts/thermic-linux-amd64/thermic-linux-amd64
            artifacts/thermic-darwin-amd64.zip/thermic-darwin-amd64.zip
            artifacts/thermic-darwin-arm64.zip/thermic-darwin-arm64.zip
          draft: false
          prerelease: false

  aur-publish:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux binary artifact
        uses: actions/download-artifact@v4
        with:
          name: thermic-linux-amd64
          path: aur-assets

      - name: Generate PKGBUILD
        run: |
          PKGVER="${GITHUB_REF_NAME#v}"

          # Compute sha256 checksums from the actual build artifacts
          BINARY_SHA=$(sha256sum aur-assets/thermic-linux-amd64 | cut -d' ' -f1)
          DESKTOP_SHA=$(sha256sum build/linux/appimage/Thermic.desktop | cut -d' ' -f1)
          ICON_SHA=$(sha256sum build/appicon.png | cut -d' ' -f1)

          echo "Version:        $PKGVER"
          echo "Binary SHA256:  $BINARY_SHA"
          echo "Desktop SHA256: $DESKTOP_SHA"
          echo "Icon SHA256:    $ICON_SHA"

          # Write PKGBUILD to workspace (accessible by Docker)
          cat > PKGBUILD <<EOF
          # Maintainer: Yuri Zhelezko <yzhelezko@github.com>
          pkgname=thermic-bin
          pkgver=${PKGVER}
          pkgrel=1
          pkgdesc="Modern cross-platform terminal emulator with SSH management and WSL support"
          arch=('x86_64')
          url="https://github.com/yzhelezko/thermic"
          license=('MIT')
          depends=('webkit2gtk-4.1' 'gtk3')
          optdepends=('openssh: SSH connection support')
          provides=('thermic')
          conflicts=('thermic' 'thermic-git')
          source=(
              "\${pkgname}-\${pkgver}::https://github.com/yzhelezko/thermic/releases/download/v\${pkgver}/thermic-linux-amd64"
              "thermic.desktop::https://raw.githubusercontent.com/yzhelezko/thermic/v\${pkgver}/build/linux/appimage/Thermic.desktop"
              "thermic.png::https://raw.githubusercontent.com/yzhelezko/thermic/v\${pkgver}/build/appicon.png"
          )
          sha256sums=('${BINARY_SHA}' '${DESKTOP_SHA}' '${ICON_SHA}')

          package() {
              install -Dm755 "\${srcdir}/\${pkgname}-\${pkgver}" "\${pkgdir}/usr/bin/thermic"
              install -Dm644 "\${srcdir}/thermic.desktop" "\${pkgdir}/usr/share/applications/thermic.desktop"
              sed -i 's|Exec=Thermic|Exec=thermic|g' "\${pkgdir}/usr/share/applications/thermic.desktop"
              sed -i 's|Icon=appicon|Icon=thermic|g' "\${pkgdir}/usr/share/applications/thermic.desktop"
              install -Dm644 "\${srcdir}/thermic.png" "\${pkgdir}/usr/share/icons/hicolor/512x512/apps/thermic.png"
          }
          EOF

          # Strip leading whitespace from heredoc indentation
          sed -i 's/^          //' PKGBUILD

          echo "=== Generated PKGBUILD ==="
          cat PKGBUILD

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: thermic-bin
          pkgbuild: ./PKGBUILD
          commit_username: ${{ github.repository_owner }}
          commit_email: yzhelezko@users.noreply.github.com
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ github.ref_name }}"
          force_push: true